# 可视化查询示例与最佳实践

## 概述
本文档提供具体的Neo4j可视化查询示例和最佳实践，帮助您在实际演示中实现最佳的可视化效果。基于金融知识图谱的数据特点，提供针对性的查询模板和优化建议。

## 一、基础可视化查询示例

### 1.1 投资方网络概览
```cypher
// 投资方及其投资行业网络（前20名活跃投资方）
MATCH (i:投资方)
WITH i, COUNT { (i)-[:投资于行业]->() } AS industryCount
ORDER BY industryCount DESC
LIMIT 20
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN i, ind, r
```

**可视化效果**:
- 投资方节点显示为蓝色圆形
- 行业节点显示为绿色方形
- 投资关系显示为红色连接线
- 使用力导向布局展示网络结构

### 1.2 行业投资热度图
```cypher
// 行业投资热度可视化（按投资次数排序）
MATCH (ind:行业)
WITH ind, COUNT { (:投资方)-[:投资于行业]->(ind) } AS investorCount
ORDER BY investorCount DESC
LIMIT 15
MATCH (i:投资方)-[r:投资于行业]->(ind)
RETURN 
  i, 
  ind, 
  r,
  investorCount AS industryPopularity
```

**可视化效果**:
- 行业节点大小与投资次数成正比
- 使用不同颜色区分投资次数等级
- 圆形布局展示行业间的关系

### 1.3 投资轮次偏好网络
```cypher
// 投资方轮次偏好网络（前15名投资方）
MATCH (i:投资方)-[r:偏好轮次]->(round:轮次)
WITH i, count(r) AS roundCount
ORDER BY roundCount DESC
LIMIT 15
MATCH (i)-[rel:偏好轮次]->(r:轮次)
RETURN i, r, rel
```

**可视化效果**:
- 投资方节点显示为蓝色
- 轮次节点显示为橙色
- 偏好关系显示为紫色连接线
- 层次布局展示投资策略

## 二、高级可视化查询示例

### 2.1 带权重的投资网络
```cypher
// 投资金额加权的公司网络
MATCH (i:投资方)-[r:投资]->(c:公司)
WHERE r.金额 IS NOT NULL
WITH c, sum(toFloat(r.金额)) AS totalAmount
ORDER BY totalAmount DESC
LIMIT 10
MATCH (investor:投资方)-[rel:投资]->(c)
WHERE rel.金额 IS NOT NULL
RETURN 
  investor, 
  c, 
  rel,
  toFloat(rel.金额) AS investmentAmount
```

**可视化效果**:
- 连接线粗细与投资金额成正比
- 节点大小与总投资金额相关
- 使用渐变颜色表示金额大小

### 2.2 核心-边缘网络分析
```cypher
// 识别网络中的核心节点和边缘节点
MATCH (i:投资方)
WITH i, COUNT { (i)-[:投资于行业]->() } AS degree
WHERE degree >= 1
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN 
  i.name AS 投资方, 
  ind.行业名称 AS 行业, 
  r,
  CASE 
    WHEN degree >= 3 THEN 'core'
    WHEN degree >= 2 THEN 'semi-core' 
    ELSE 'edge'
  END AS nodeType
LIMIT 20
```

**可视化效果**:
- 核心节点显示为大红色
- 半核心节点显示为橙色
- 边缘节点显示为浅蓝色
- 清晰展示网络层次结构

### 2.3 投资策略聚类分析
```cypher
// 基于投资行业数量的投资方聚类
MATCH (i:投资方)
WITH i, COUNT { (i)-[:投资于行业]->() } AS industryCount
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN 
  i, 
  ind, 
  r,
  CASE 
    WHEN industryCount = 1 THEN 'specialized'
    WHEN industryCount <= 5 THEN 'focused'
    WHEN industryCount <= 15 THEN 'diversified'
    ELSE 'highly-diversified'
  END AS strategyType
```

**可视化效果**:
- 专业化策略显示为绿色
- 聚焦策略显示为蓝色
- 多元化策略显示为黄色
- 高度多元化显示为红色

## 三、交互式可视化查询

### 3.1 点击展开详细视图
```cypher
// 点击投资方查看详细投资组合
MATCH (selectedInvestor:投资方 {name: $clickedInvestor})
MATCH (selectedInvestor)-[r1:投资于行业]->(ind:行业)
MATCH (selectedInvestor)-[r2:偏好轮次]->(round:轮次)
RETURN selectedInvestor, ind, round, r1, r2
```

**交互功能**:
- 点击任意投资方节点
- 自动展开该投资方的所有投资行业和偏好轮次
- 高亮显示相关连接

### 3.2 动态过滤查询

#### 查询示例（基于实际数据）
```cypher
// 根据投资金额范围动态过滤（使用实际存在的金额数据）
MATCH (i:投资方)-[r:投资]->(c:公司)
WHERE r.金额 IS NOT NULL 
  AND toFloat(r.金额) >= $minAmount 
  AND toFloat(r.金额) <= $maxAmount
RETURN 
  i.name AS 投资方, 
  c.name AS 公司, 
  toFloat(r.金额) AS 投资金额,
  r
ORDER BY toFloat(r.金额) DESC
LIMIT 50
```

#### 参数示例
```cypher
// 示例1：小额投资（2000万以下）
$minAmount = 0
$maxAmount = 20000000

// 示例2：中等投资（2000万-1亿）
$minAmount = 20000000
$maxAmount = 100000000

// 示例3：大额投资（1亿以上）
$minAmount = 100000000
$maxAmount = 504560000000
```

#### 测试查询（验证数据存在）
```cypher
// 测试查询：查看中等投资范围的数据
MATCH (i:投资方)-[r:投资]->(c:公司)
WHERE r.金额 IS NOT NULL 
  AND toFloat(r.金额) >= 20000000 
  AND toFloat(r.金额) <= 100000000
RETURN 
  i.name AS 投资方, 
  c.name AS 公司, 
  toFloat(r.金额) AS 投资金额
ORDER BY toFloat(r.金额) DESC
LIMIT 10
```

**交互功能**:
- 滑块控制投资金额范围（建议范围：2万-5045.6亿）
- 实时更新可视化结果
- 动态调整节点和连接显示
- 支持按投资金额排序

### 3.3 路径探索查询
```cypher
// 探索两个投资方之间的关联路径
MATCH path = shortestPath((i1:投资方 {name: $investor1})-[*1..5]-(i2:投资方 {name: $investor2}))
WHERE i1 <> i2
RETURN path
```

**交互功能**:
- 选择两个投资方
- 自动计算最短关联路径
- 高亮显示连接路径

## 四、样式定制最佳实践

### 4.1 节点样式定制
```cypher
// 根据节点类型和属性定制样式
MATCH (n)
RETURN 
  n,
  CASE 
    WHEN '投资方' IN labels(n) THEN 
      CASE 
        WHEN COUNT { (n)-[:投资于行业]->() } > 10 THEN '#1f77b4'  // 深蓝 - 高度活跃
        WHEN COUNT { (n)-[:投资于行业]->() } > 5 THEN '#aec7e8'   // 浅蓝 - 中等活跃
        ELSE '#d3d3d3'                                       // 灰色 - 低活跃
      END
    WHEN '行业' IN labels(n) THEN 
      CASE 
        WHEN COUNT { (:投资方)-[:投资于行业]->(n) } > 50 THEN '#2ca02c'  // 深绿 - 热门行业
        WHEN COUNT { (:投资方)-[:投资于行业]->(n) } > 20 THEN '#98df8a'  // 浅绿 - 中等热门
        ELSE '#c7c7c7'                                                // 灰色 - 冷门行业
      END
    ELSE '#ff7f0e'  // 橙色 - 其他类型
  END AS color,
  CASE 
    WHEN '投资方' IN labels(n) THEN COUNT { (n)-[:投资于行业]->() } * 0.5 + 1.0
    WHEN '行业' IN labels(n) THEN COUNT { (:投资方)-[:投资于行业]->(n) } * 0.3 + 1.0
    ELSE 1.0
  END AS size
```

### 4.2 关系样式定制
```cypher
// 根据关系属性和类型定制样式
MATCH (i:投资方)-[r]->(target)
RETURN 
  i,
  target,
  r,
  CASE 
    WHEN type(r) = '投资于行业' AND r.amount IS NOT NULL THEN
      CASE 
        WHEN toFloat(r.amount) > 100 THEN '#d62728'  // 深红 - 大额投资
        WHEN toFloat(r.amount) > 10 THEN '#ff9896'   // 浅红 - 中等投资
        ELSE '#f7b6d2'                               // 粉红 - 小额投资
      END
    WHEN type(r) = '偏好轮次' THEN '#9467bd'     // 紫色 - 轮次偏好
    ELSE '#8c564b'                                   // 棕色 - 其他关系
  END AS color,
  CASE 
    WHEN type(r) = '投资于行业' AND r.amount IS NOT NULL THEN
      log(toFloat(r.amount)) * 0.5 + 1.0
    ELSE 1.0
  END AS width
```

## 五、布局算法选择指南

### 5.1 力导向布局（Force Atlas）
**适用场景**: 网络结构探索、关系密度分析
**优势**: 自然展示节点间的关系强度
**查询示例**:
```cypher
MATCH (i:投资方)-[r:投资于行业]->(ind:行业)
RETURN i, ind, r
```

### 5.2 圆形布局（Circular）
**适用场景**: 层次结构展示、分类比较
**优势**: 清晰展示节点间的层次关系
**查询示例**:
```cypher
MATCH (ind:行业)
WITH ind, COUNT { (:投资方)-[:投资于行业]->(ind) } AS count
ORDER BY count DESC
LIMIT 10
MATCH (i:投资方)-[r:投资于行业]->(ind)
RETURN i, ind, r
```

### 5.3 层次布局（Hierarchical）
**适用场景**: 组织结构、分类树状图
**优势**: 明确展示父子关系和层级
**查询示例**:
```cypher
MATCH (i:投资方)-[r:偏好轮次]->(round:轮次)
RETURN i, round, r
```

## 六、性能优化最佳实践

### 6.1 查询性能优化
```cypher
// 优化前 - 性能较差
MATCH (i:投资方)-[r:投资于行业]->(ind:行业)
WHERE i.name CONTAINS '资本'
RETURN i, ind, r

// 优化后 - 使用索引和限制
MATCH (i:投资方)
WHERE i.name CONTAINS '资本'
WITH i
LIMIT 50
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN i, ind, r
```

### 6.2 数据预处理优化
```cypher
// 预处理常用统计指标
MATCH (i:投资方)
SET i.industryCount = COUNT { (i)-[:投资于行业]->() }

MATCH (ind:行业) 
SET ind.investorCount = COUNT { (:投资方)-[:投资于行业]->(ind) }
```

### 6.3 分批加载策略
```cypher
// 分批加载大型网络
MATCH (i:投资方)
WITH i, COUNT { (i)-[:投资于行业]->() } AS degree
ORDER BY degree DESC
SKIP $batch * 50
LIMIT 50
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN i, ind, r
```

## 七、演示流程设计

### 7.1 标准演示流程
1. **概览展示**: 网络整体结构
2. **核心分析**: 关键节点和关系
3. **细节探索**: 具体投资案例
4. **趋势洞察**: 模式发现和预测

### 7.2 交互式演示脚本
```cypher
// 第一步：网络概览
MATCH (i:投资方)-[r:投资于行业]->(ind:行业)
WITH i, ind, r
LIMIT 100
RETURN i, ind, r

// 第二步：核心投资方
MATCH (i:投资方)
WITH i, COUNT { (i)-[:投资于行业]->() } AS degree
WHERE degree >= 5
MATCH (i)-[r:投资于行业]->(ind:行业)
RETURN i, ind, r

// 第三步：热门行业
MATCH (ind:行业)
WITH ind, COUNT { (:投资方)-[:投资于行业]->(ind) } AS count
WHERE count >= 10
MATCH (i:投资方)-[r:投资于行业]->(ind)
RETURN i, ind, r
```

## 八、故障排除和调试

### 8.1 常见问题解决
- **可视化混乱**: 减少节点数量，使用合适的布局
- **性能问题**: 添加索引，优化查询语句
- **内存不足**: 分批加载数据

### 8.2 调试工具使用
```cypher
// 使用PROFILE分析查询性能
PROFILE MATCH (i:投资方)-[r:投资于行业]->(ind:行业)
RETURN count(*)

// 使用EXPLAIN查看执行计划
EXPLAIN MATCH (i:投资方)-[r:投资于行业]->(ind:行业)
WHERE i.name = '某投资方'
RETURN i, ind, r
```

## 九、总结

通过本文档提供的可视化查询示例和最佳实践，您可以：

1. **快速上手**: 使用现成的查询模板进行演示
2. **深度定制**: 根据具体需求调整可视化效果
3. **性能优化**: 确保大规模数据的流畅展示
4. **交互设计**: 创建富有吸引力的演示体验

建议在实际使用前，先在测试环境中验证查询效果，确保满足您的具体演示需求。

---

**文档版本**: 1.0  
**最后更新**: 2025年12月21日  
**适用Neo4j版本**: 4.x及以上